<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Movie Watchlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Configuration will be loaded from environment variables -->
    <!-- Style -->
    <style>
      :root {
        --primary: #22223b;
        --secondary: #4a4e69;
        --accent: #9a8c98;
        --bg: #f2e9e4;
        --white: #fff;
        --radius: 10px;
      }
      body {
        margin: 0;
        font-family: 'Segoe UI', Arial, sans-serif;
        background: var(--bg);
        color: var(--primary);
        min-height: 100vh;
      }
      header {
        background: var(--primary);
        color: var(--white);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--accent);
      }
      .btn {
        background: var(--secondary);
        color: var(--white);
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
      }
      .btn:hover {
        background: var(--accent);
        color: var(--primary);
      }
      main {
        max-width: 900px;
        margin: 2rem auto;
        background: var(--white);
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .search-section,
      .watchlist-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .search-bar {
        display: flex;
        gap: 1rem;
      }
      .search-bar input {
        flex: 1;
        padding: 0.5rem;
        border-radius: var(--radius);
        border: 1px solid var(--accent);
        font-size: 1rem;
      }
      .movies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.5rem;
      }
      .movie-card {
        background: var(--bg);
        border-radius: var(--radius);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
      }
      .movie-card img {
        width: 100px;
        height: 150px;
        object-fit: cover;
        border-radius: var(--radius);
        background: #eee;
      }
      .movie-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin: 0.5rem 0 0.2rem 0;
      }
      .movie-year {
        color: var(--secondary);
        font-size: 0.95rem;
      }
      .error-message {
        color: #d32f2f;
        background: #ffebee;
        padding: 1rem;
        border-radius: var(--radius);
        border-left: 4px solid #d32f2f;
        margin: 1rem 0;
      }
      .loading {
        text-align: center;
        padding: 2rem;
        color: var(--secondary);
      }
      @media (max-width: 600px) {
        header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }
        main {
          padding: 1rem;
        }
        .movies-grid {
          grid-template-columns: 1fr 1fr;
        }
        .search-bar {
          flex-direction: column;
        }
      }
      @media (max-width: 400px) {
        .movies-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div><strong>üé¨ Movie Watchlist</strong></div>
      <div class="user-info" id="user-info" style="display: none">
        <img id="user-pic" src="" alt="User Picture" />
        <span id="user-name"></span>
        <button class="btn" id="logout-btn">Logout</button>
      </div>
      <button class="btn" id="login-btn" style="display: block">
        Login with Google
      </button>
    </header>
    <main>
      <section class="search-section">
        <h2>Search Movies</h2>
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            placeholder="Enter movie title..."
          />
          <button class="btn" id="search-btn">Search</button>
        </div>
        <div class="movies-grid" id="search-results"></div>
      </section>
      <section class="watchlist-section">
        <h2>Your Watchlist</h2>
        <div class="movies-grid" id="watchlist"></div>
      </section>
    </main>
    <script>
      // --- Load Configuration from Netlify Environment Variables ---
      const config = {
        firebase: {
          apiKey: "%%FIREBASE_API_KEY%%",
          authDomain: "%%FIREBASE_AUTH_DOMAIN%%",
          projectId: "%%FIREBASE_PROJECT_ID%%",
          storageBucket: "%%FIREBASE_STORAGE_BUCKET%%",
          messagingSenderId: "%%FIREBASE_MESSAGING_SENDER_ID%%",
          appId: "%%FIREBASE_APP_ID%%",
          measurementId: "%%FIREBASE_MEASUREMENT_ID%%"
        },
        omdb: {
          apiKey: "%%OMDB_API_KEY%%"
        }
      };

      // Validate config - check if environment variables were replaced
      if (config.firebase.apiKey.includes('%%') || config.omdb.apiKey.includes('%%')) {
        document.body.innerHTML = `
          <div class="error-message">
            <h2>Configuration Error</h2>
            <p>Environment variables not properly configured. Please check your Netlify environment settings.</p>
          </div>
        `;
        throw new Error('Environment variables not configured');
      }

      // --- Firebase Setup ---
      try {
        firebase.initializeApp(config.firebase);
        const auth = firebase.auth();
      } catch (error) {
        document.body.innerHTML = `
          <div class="error-message">
            <h2>Firebase Error</h2>
            <p>Failed to initialize Firebase: ${error.message}</p>
          </div>
        `;
        throw error;
      }

      // --- DOM Elements ---
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userInfo = document.getElementById('user-info');
      const userPic = document.getElementById('user-pic');
      const userName = document.getElementById('user-name');
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      const searchResults = document.getElementById('search-results');
      const watchlistGrid = document.getElementById('watchlist');

      // --- Watchlist Storage (In-memory for client-side storage) ---
      let watchlistData = {};

      function getWatchlistKey(uid) {
        return `watchlist_${uid}`;
      }
      
      function getWatchlist(uid) {
        // Try to load from localStorage first, fallback to memory
        try {
          const stored = localStorage.getItem(getWatchlistKey(uid));
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (e) {
          console.warn('localStorage not available, using memory storage');
        }
        return watchlistData[uid] || [];
      }
      
      function saveWatchlist(uid, list) {
        // Save to both localStorage and memory
        watchlistData[uid] = list;
        try {
          localStorage.setItem(getWatchlistKey(uid), JSON.stringify(list));
        } catch (e) {
          console.warn('localStorage not available, using memory storage only');
        }
      }

      // --- Auth Handlers ---
      loginBtn.onclick = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
          console.error('Login error:', error);
          alert('Login failed. Please try again.');
        });
      };
      
      logoutBtn.onclick = () => {
        auth.signOut().catch((error) => {
          console.error('Logout error:', error);
        });
      };

      auth.onAuthStateChanged((user) => {
        if (user) {
          // Show user info
          userInfo.style.display = 'flex';
          loginBtn.style.display = 'none';
          userPic.src = user.photoURL || 'https://via.placeholder.com/40x40?text=üë§';
          userName.textContent = user.displayName || 'User';
          // Load watchlist
          renderWatchlist();
        } else {
          userInfo.style.display = 'none';
          loginBtn.style.display = 'block';
          userPic.src = '';
          userName.textContent = '';
          watchlistGrid.innerHTML = '<div>Please log in to see your watchlist.</div>';
        }
      });

      // --- Movie Search ---
      searchBtn.onclick = searchMovies;
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') searchMovies();
      });

      function searchMovies() {
        const query = searchInput.value.trim();
        if (!query) {
          alert('Please enter a movie title to search.');
          return;
        }
        
        searchResults.innerHTML = '<div class="loading">üîç Searching for movies...</div>';
        
        fetch(
          `https://www.omdbapi.com/?apikey=${config.omdb.apiKey}&s=${encodeURIComponent(query)}&type=movie`
        )
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            if (data.Response === 'True') {
              renderMovies(data.Search, searchResults, true);
            } else {
              searchResults.innerHTML = `<div>No movies found for "${query}". Try a different search term.</div>`;
            }
          })
          .catch((error) => {
            console.error('Search error:', error);
            searchResults.innerHTML = `<div class="error-message">Error searching for movies. Please check your internet connection and try again.</div>`;
          });
      }

      // --- Render Movies ---
      function renderMovies(movies, container, canAdd) {
        container.innerHTML = '';
        movies.forEach((movie) => {
          const card = document.createElement('div');
          card.className = 'movie-card';
          
          const posterUrl = movie.Poster !== 'N/A' 
            ? movie.Poster 
            : 'https://via.placeholder.com/100x150?text=No+Image';
            
          card.innerHTML = `
            <img src="${posterUrl}" alt="${movie.Title} Poster" onerror="this.src='https://via.placeholder.com/100x150?text=No+Image'">
            <div class="movie-title">${movie.Title}</div>
            <div class="movie-year">${movie.Year}</div>
          `;
          
          if (canAdd && auth.currentUser) {
            const watchlist = getWatchlist(auth.currentUser.uid);
            const isInWatchlist = watchlist.find((m) => m.imdbID === movie.imdbID);
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.textContent = isInWatchlist ? 'In Watchlist' : 'Add to Watchlist';
            addBtn.disabled = isInWatchlist;
            addBtn.onclick = () => addToWatchlist(movie);
            card.appendChild(addBtn);
          }
          
          if (!canAdd) {
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => removeFromWatchlist(movie.imdbID);
            card.appendChild(removeBtn);
          }
          
          container.appendChild(card);
        });
      }

      // --- Watchlist Handlers ---
      function addToWatchlist(movie) {
        const user = auth.currentUser;
        if (!user) {
          alert('Please log in to add movies to your watchlist.');
          return;
        }
        
        let list = getWatchlist(user.uid);
        if (!list.find((m) => m.imdbID === movie.imdbID)) {
          list.push(movie);
          saveWatchlist(user.uid, list);
          renderWatchlist();
          // Refresh search results to show updated button states
          const query = searchInput.value.trim();
          if (query) {
            searchMovies();
          }
        }
      }
      
      function removeFromWatchlist(imdbID) {
        const user = auth.currentUser;
        if (!user) return;
        
        let list = getWatchlist(user.uid);
        list = list.filter((m) => m.imdbID !== imdbID);
        saveWatchlist(user.uid, list);
        renderWatchlist();
      }
      
      function renderWatchlist() {
        const user = auth.currentUser;
        if (!user) {
          watchlistGrid.innerHTML = '<div>Please log in to see your watchlist.</div>';
          return;
        }
        
        const list = getWatchlist(user.uid);
        if (list.length === 0) {
          watchlistGrid.innerHTML = '<div>Your watchlist is empty. Search for movies above to add them!</div>';
        } else {
          renderMovies(list, watchlistGrid, false);
        }
      }
    </script>
  </body>
</html>
